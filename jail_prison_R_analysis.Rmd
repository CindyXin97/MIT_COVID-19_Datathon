```{r}
library(tidyverse)
```

nyt_data: county-level COVID statistics
jp: jail population, surrounding county population
full data: jail population, cases, deaths for each county over time
```{r}
nyt_data = read_csv('NYT_data/us-counties.csv')
jp = read_csv('https://raw.githubusercontent.com/vera-institute/jail-population-data/master/jail_population.csv')
jp <- jp %>% rename(county = county_name) %>% rename(state=state_name) %>% arrange(date)
jp$county<-str_remove(jp$county," County")
nyt_data %>% select(date,county,state,cases,deaths) %>% arrange(county)
jp %>% select(date,county,state,jail_population,resident_population,jail_incarceration_rate_per_100k,urbanicity)

full_data <- merge(jp,nyt_data,by = c('date','county','state')) %>% select(date,county,state,jail_population,resident_population,cases,deaths,jail_incarceration_rate_per_100k,urbanicity)
full_data %>% arrange(county,state)

write.csv(full_data,"jail_county_df.csv")
```
Cluster: predict covid rates, average increase? something as a function of incaraceration rate, urbanicity, jail population

recent: most recent statistics
```{r}
full_data_recent <- full_data %>% filter(date == as.Date("2020-05-11"))
ggplot(data = full_data_recent) + 
  geom_point(aes(log(jail_incarceration_rate_per_100k),log(cases),color=log(resident_population)))+
  scale_color_gradient(low="blue", high="red")
```


% difference in jail population and cases from March 1st to now
```{r}
full_data %>% arrange((date)) 
diff_df <- full_data %>% arrange((date)) %>% filter(date >= as.Date("2020-03-01")) %>% group_by(county,state) %>%
  mutate(frac_jail_red = (first(jail_population)-last(jail_population))/first(jail_population)) %>%
  mutate(frac_increase_cases = (last(cases)-first(cases))/first(cases)) %>%
  select(county,state,frac_jail_red,frac_increase_cases) %>% distinct %>% arrange(desc(frac_increase_cases))
diff_df
```

Relationship between % difference in cases and % difference in jail population?
```{r}
diff_df
ggplot(data = diff_df) + geom_point(aes((log(frac_jail_red)),log(frac_increase_cases)))
```
Cluster: predict covid rates, average increase? something as a function of incaraceration rate, urbanicity, jail population

```{r}
quantile(df$abs_mean_jail_pop_diff)
df <- full_data %>% arrange(date)
df <- df %>% group_by(county,state) %>% mutate(jail_pop_diff = jail_population-lag(jail_population,3)) %>%
  mutate(ir = cases/resident_population) %>%
  arrange(county,state,date) %>% drop_na() %>% 
  filter(date >= as.Date('2020-04-01')) %>%
  mutate(abs_mean_jail_pop_diff = abs(mean(jail_pop_diff))) %>%
  mutate(mean_ir = mean(ir)) %>%
  mutate(mean_incarceration = mean(jail_incarceration_rate_per_100k))
df
no_change_counties <- df %>% filter(abs_mean_jail_pop_diff>=5)  %>% 
  group_by(county,state) %>% mutate(n= n()) %>% filter(n>=10) %>% 
  arrange(desc(jail_incarceration_rate_per_100k))
ncc <- no_change_counties %>%
  select(county,state,mean_incarceration,resident_population,mean_ir) %>% 
  unique() %>% arrange(desc(mean_incarceration))
ncc
ggplot(ncc) + geom_point(aes(log(mean_incarceration),log(mean_ir),color=log((resident_population))))
```


```{r}
jail_counties <- jp%>% select(county,state) %>% unique()
jail_counties$countystate <- paste(jail_counties$county, jail_counties$state, sep=", ")
nyt_data$countystate <- paste(nyt_data$county, nyt_data$state, sep=", ")
jail_counties
nyt_data
no_jail_counties <- nyt_data %>% filter(!(countystate %in% jail_counties$countystate))
nrow(nyt_data %>% select(county,state) %>% unique())
nrow(full_data%>% select(county,state) %>% unique())
nrow(jp%>% select(county,state) %>% unique())
```


```{r}
dat <- merge(full_data,diff_df) %>% arrange(county,state,date)
dat$infection_rate <- dat$cases/dat$resident_population
dat$three_day_infection_increase <- dat$infection_rate-lag(dat$infection_rate,3)
dat$three_day_jail_decrease <-lag(dat$jail_population,3)-dat$jail_population
# 1280 counties
dat %>% select(county,state,date,jail_population,resident_population,three_day_infection_increase,jail_incarceration_rate_per_100k,urbanicity)
```


Look at a particular county
```{r}
countyname = 'Clackamas'
statename = 'Oregon'
county_data <- full_data %>% filter(county==countyname,state==statename)%>% select(county,date,jail_population,cases)
county_data$release_rate <- (lag(county_data$jail_population,3)-county_data$jail_population)/lag(county_data$jail_population,3)*500
county_data

ggplot(data=melt(county_data, id=c('date','county'))) + geom_line(aes(date,value,color=variable))
```

Look at an entire state
```{r}
statename = 'Oregon'
state_data <- full_data %>% filter(state==statename) %>% group_by(date) %>% mutate(total_jailed = sum(jail_population)) %>%
  mutate(total_cases = sum(cases)) %>% select(date,total_jailed,total_cases) %>% unique()
state_data
ggplot(data=melt(state_data, id=c('date'))) + geom_line(aes(date,value,color=variable))
```

Prison analysis

```{r}
prisons <- read_csv('prison_boundaries.csv')
prisons$COUNTY <- tolower(prisons$COUNTY)
prisons <- prisons %>% rename(county = COUNTY,Code=STATE)
str_list <- paste(c('CORRECTION','PRISON'), collapse="|")
prisons <- prisons %>% filter(grepl(str_list,NAME))
prisons %>% select(NAME,Code,county)

statenames <- read_csv('state_abbreviations.csv') %>% select(State,Code)
prison_df <- merge(statenames,prisons) %>% select(State,NAME,county) %>% unique()
prison_df
```

Prison data: for each state, fraction of prisoners released
```{r}
pr <- read_csv('covid_prison_releases.csv') %>%
  rename(prior_pop = 'Population Prior to Releases',releases = "Overall Pop. Reduction / \nTotal Number of Releases") %>% 
  select(State,Facility,prior_pop,releases) %>% 
  filter(Facility=='Statewide') %>%
  mutate(releases = as.numeric(releases)) %>%
  mutate(frac_released = releases/prior_pop) %>%
  select(State,frac_released) %>% drop_na()
pr

prison_counties_frac_released <- merge(prison_df, pr,by='State',all.x = TRUE) %>%
  mutate(frac_released = ifelse(is.na(frac_released),0,frac_released)) %>%
  mutate(countystate = paste(county,State,sep=", ")) %>% 
  select(countystate,frac_released) %>% unique()
prison_counties_frac_released

```

```{r}
county_pop <- read_csv('county_populations.csv') %>% filter(grepl("County",CTYNAME)) %>% mutate(countystate = paste(tolower(str_remove(CTYNAME," County")),STNAME,sep = ", ")) %>% select(countystate,CENSUS2010POP)
#county_pop

nytdf <- nyt_data %>% mutate(countystate = paste(tolower(county),state,sep=", ")) %>%
  mutate(prison_county = ifelse(countystate %in% prison_counties_frac_released$countystate,1,0)) %>% unique()

nyt_with_prisons <- merge(nytdf, prison_counties_frac_released, all.x=TRUE) %>% group_by(countystate) %>%
  arrange(countystate,date) %>%
  mutate(diff_cases = cases-lag(cases,7)) %>%
  filter(date >= as.Date('2020-03-01')) %>%
  filter(!is.na(diff_cases)) %>%
  select(countystate,date,cases,prison_county,frac_released,diff_cases)

prison_pop_df <- merge(nyt_with_prisons,county_pop,all.x=TRUE)
#prison_pop_df
write.csv(prison_pop_df,"prison_county_df.csv")

prison_counties <- prison_pop_df %>% filter(prison_county==1)
#prison_counties

length(unique(prison_pop_df$countystate))
length(unique(prison_counties$countystate))
nrow(prison_counties)

model1 <- glm(diff_cases ~ CENSUS2010POP + frac_released, data = prison_counties)
summary(model1)

model2 <- glm(diff_cases ~ CENSUS2010POP + prison_county, data = prison_pop_df)
summary(model2)
```

The other way to approach this would be to interact release rate with whether or not a county has a prison to keep sample
(frac_release X prison_county) + prison_county + frac_release

```{r}
prison_pop_df_with_indicator <-prison_pop_df %>% mutate(frac_released_for_indicator = ifelse(is.na(frac_released),0,frac_released)) %>%
  select(countystate,date,prison_county,frac_released_for_indicator,diff_cases,CENSUS2010POP) %>% drop_na() %>%
  mutate(int_prison_county_frac_released = prison_county*frac_released_for_indicator)

prison_pop_df_with_indicator %>% filter(int_prison_county_frac_released !=0)

model3 <- glm(diff_cases ~ CENSUS2010POP + int_prison_county_frac_released + prison_county + frac_released,data = prison_pop_df_with_indicator)
summary(model3)
```

Let's look at regression of change of infection rates on proportion released with controls for county demographics, crime rates, population density, age, income.

```{r}
df <- full_data %>% arrange(date) %>% group_by(county,state) %>% 
  mutate(jail_pop_diff = jail_population-lag(jail_population,7)) %>%
  mutate(ir = cases/resident_population) %>%
  mutate(ir_diff = ir-lag(ir,7)) %>%
  arrange(county,state,date) %>% drop_na() %>%
  mutate(density = ifelse(urbanicity=='urban',3,
                           ifelse(urbanicity=='small/mid',2,1))) %>%
  select(date,county,state,jail_pop_diff,resident_population,ir_diff,density)
  #filter(date >= as.Date('2020-04-01')) %>%
df

model <- glm(ir_diff ~ jail_pop_diff + resident_population + density, data = df)
summary(model)
```


(Not 100% sure about this analysis--please help!)
```{r}
# jail population dataframe with fraction released

frac_rel <- full_data %>% group_by(county,state) %>% filter(first(jail_population) >20)%>% 
  mutate(num_released = first(jail_population)-last(jail_population)) %>% 
  mutate(frac_released = num_released/first(jail_population)) %>%
  mutate(infection_rate=cases/resident_population) %>%
  select(county,state,frac_released,num_released,resident_population,infection_rate) %>%
  unique() %>% arrange(desc(frac_released))
  
frac_rel

# 5 quantiles
(quantile(frac_rel$frac_released, c(.2,.4,.6,.8,1)))


frac_rel$quantile <- ifelse(frac_rel$frac_released<.08,5,
                               ifelse(frac_rel$frac_released<.16,4,
                                      ifelse(frac_rel$frac_released<.24,3,
                                             ifelse(frac_rel$frac_released<.34,2,1))))

frac_rel$quantile <- as.factor(frac_rel$quantile)

release_df <- merge(full_data_recent,frac_rel) %>%
  mutate(infection_rate=cases/resident_population) %>% select(county,state,resident_population,infection_rate,frac_released,quantile) %>% unique()
release_df$quantile <- as.factor(release_df$quantile) 

table(release_df$quantile)

release_df
ggplot(release_df) + geom_violin(aes(quantile,log(infection_rate)))
```



```{r}
ggplot(release_df) + geom_point(aes(log(frac_released),log(infection_rate)))
```

