```{r}
library(tidyverse)
```

nyt_data: county-level COVID statistics
jp: jail population, surrounding county population
full data: jail population, cases, deaths for each county over time
```{r}
nyt_data = read_csv('NYT_data/us-counties.csv')
jp = read_csv('https://raw.githubusercontent.com/vera-institute/jail-population-data/master/jail_population.csv')
jp <- jp %>% rename(county = county_name) %>% rename(state=state_name) %>% arrange(date)
jp$county<-str_remove(jp$county," County")
nyt_data %>% select(date,county,state,cases,deaths) %>% arrange(county)
jp %>% select(date,county,state,jail_population,resident_population,jail_incarceration_rate_per_100k,urbanicity)

full_data <- merge(jp,nyt_data,by = c('date','county','state')) %>% select(date,county,state,jail_population,resident_population,cases,deaths,jail_incarceration_rate_per_100k,urbanicity)
full_data %>% arrange(county,state)

write.csv(full_data,"jail_county_df.csv")
```

recent: most recent statistics
```{r}
full_data_recent <- full_data %>% filter(date == as.Date("2020-05-11"))
ggplot(data = full_data_recent) + 
  geom_point(aes(log(jail_incarceration_rate_per_100k),log(cases),color=log(resident_population)))+
  scale_color_gradient(low="blue", high="red")
```


% difference in jail population and cases from March 1st to now
```{r}
full_data %>% arrange((date)) 
diff_df <- full_data %>% arrange((date)) %>% filter(date >= as.Date("2020-03-01")) %>% group_by(county,state) %>%
  mutate(frac_jail_red = (first(jail_population)-last(jail_population))/first(jail_population)) %>%
  mutate(frac_increase_cases = (last(cases)-first(cases))/first(cases)) %>%
  select(county,state,frac_jail_red,frac_increase_cases) %>% distinct %>% arrange(desc(frac_increase_cases))
diff_df
```

Relationship between % difference in cases and % difference in jail population?
```{r}
diff_df
ggplot(data = diff_df) + geom_point(aes((log(frac_jail_red)),log(frac_increase_cases)))
```

Look at a particular county
```{r}
countyname = 'Clackamas'
statename = 'Oregon'
county_data <- full_data %>% filter(county==countyname,state==statename)%>% select(county,date,jail_population,cases)
county_data$release_rate <- (lag(county_data$jail_population,3)-county_data$jail_population)/lag(county_data$jail_population,3)*500
county_data

ggplot(data=melt(county_data, id=c('date','county'))) + geom_line(aes(date,value,color=variable))
```

Look at an entire state
```{r}
statename = 'Oregon'
state_data <- full_data %>% filter(state==statename) %>% group_by(date) %>% mutate(total_jailed = sum(jail_population)) %>%
  mutate(total_cases = sum(cases)) %>% select(date,total_jailed,total_cases) %>% unique()
state_data
ggplot(data=melt(state_data, id=c('date'))) + geom_line(aes(date,value,color=variable))
```

Prison analysis

```{r}
prisons <- read_csv('prison_boundaries.csv')
prisons$COUNTY <- tolower(prisons$COUNTY)
prisons <- prisons %>% rename(county = COUNTY,Code=STATE)
#prisons %>% select(NAME,Code,county)

statenames <- read_csv('state_abbreviations.csv') %>% select(State,Code)
prison_df <- merge(statenames,prisons) %>% select(State,NAME,county)
prison_df
```

Prison data: for each state, fraction of prisoners released
```{r}
pr <- read_csv('covid_prison_releases.csv') 
pr <- pr %>% rename(prior_pop = 'Population Prior to Releases',releases = "Overall Pop. Reduction / \nTotal Number of Releases") %>% select(State,Facility,prior_pop,releases) %>% drop_na() %>% filter(Facility=='Statewide')
pr$releases <- as.numeric(pr$releases)
pr$frac_released <- pr$releases/pr$prior_pop
pr <- pr %>% drop_na()
pr %>% arrange(frac_released)
```

For each prison county, the cases over time, and the fraction of prisoners released in that state
```{r}
# state, frac_released, county containing a prison
PRDF <- merge(pr,prison_df) %>% select(State,frac_released,county) %>% rename(state=State)
nyt_data$county <- tolower(nyt_data$county)
PRDF <- merge(nyt_data,PRDF)
PRDF <- PRDF %>% select(county,state,frac_released,date,cases,deaths)
write.csv(PRDF,"prison_county_df.csv")
```

```{r}
PRDF
```


(Not 100% sure about this analysis--please help!)
```{r}
# jail population dataframe with fraction released

frac_rel <- full_data %>% group_by(county,state) %>% filter(first(jail_population) >20)%>% 
  mutate(num_released = first(jail_population)-last(jail_population)) %>% 
  mutate(frac_released = num_released/first(jail_population)) %>%
  mutate(infection_rate=cases/resident_population) %>%
  select(county,state,frac_released,num_released,resident_population,infection_rate) %>%
  unique() %>% arrange(desc(frac_released))
  
frac_rel

# 5 quantiles
(quantile(frac_rel$frac_released, c(.2,.4,.6,.8,1)))


frac_rel$quantile <- ifelse(frac_rel$frac_released<.08,5,
                               ifelse(frac_rel$frac_released<.16,4,
                                      ifelse(frac_rel$frac_released<.24,3,
                                             ifelse(frac_rel$frac_released<.34,2,1))))

frac_rel$quantile <- as.factor(frac_rel$quantile)

release_df <- merge(full_data_recent,frac_rel) %>%
  mutate(infection_rate=cases/resident_population) %>% select(county,state,resident_population,infection_rate,frac_released,quantile) %>% unique()
release_df$quantile <- as.factor(release_df$quantile) 

table(release_df$quantile)

release_df
ggplot(release_df) + geom_violin(aes(quantile,log(infection_rate)))
```



```{r}
ggplot(release_df) + geom_point(aes(log(frac_released),log(infection_rate)))
```

