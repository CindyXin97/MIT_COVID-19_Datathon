```{r}
library(tidyverse)
```

nyt_data: county-level COVID statistics
jp: jail population, surrounding county population
```{r}
nyt_data = read_csv('NYT_data/us-counties.csv')
jp = read_csv('https://raw.githubusercontent.com/vera-institute/jail-population-data/master/jail_population.csv')
jp <- jp %>% rename(county = county_name) %>% rename(state=state_name) %>% arrange(date)
jp$county<-str_remove(jp$county," County")
nyt_data %>% select(date,county,state,cases,deaths) %>% arrange(county)
jp %>% select(date,county,state,jail_population,resident_population,jail_incarceration_rate_per_100k,urbanicity)
```

recent: most recent statistics

```{r}
jp_recent <- jp %>% filter(date == as.Date("2020-05-011"))
nyt_recent <- nyt_data %>% filter(date == as.Date("2020-05-011"))
nyt_jp_recent <-merge(x=jp_recent,y=nyt_recent,by=c('county','state'),all.x=TRUE) %>% select(county,state,jail_population,resident_population,
                                                                                             jail_incarceration_rate_per_100k,cases,deaths) %>%
  filter(!is.na(cases))
nyt_jp_recent$cases_per_capita <- nyt_jp_recent$cases/nyt_jp_recent$resident_population
nyt_jp_recent
ggplot(data = nyt_jp_recent) + geom_point(aes(log(jail_population),log(resident_population),color=log(cases_per_capita)))+scale_color_gradient(low="blue", high="red")
```

```{r}
jp_recent <- jp %>% filter(date == as.Date("2020-05-011"))
nyt_recent <- nyt_data %>% filter(date == as.Date("2020-05-011"))
nyt_jp_recent <-merge(x=jp_recent,y=nyt_recent,by=c('county','state'),all.x=TRUE) %>% select(county,state,jail_population,resident_population,
                                                                                             jail_incarceration_rate_per_100k,cases,deaths) %>%
  filter(!is.na(cases))
nyt_jp_recent$cases_per_capita <- nyt_jp_recent$cases/nyt_jp_recent$resident_population
nyt_jp_recent
ggplot(data = nyt_jp_recent) + geom_point(aes(log(jail_incarceration_rate_per_100k),log(cases_per_capita)))
```

% difference in jail population from March 1st to now
```{r}
jp_diff <- jp %>% filter(jail_population>100)%>% filter(date >= as.Date("2020-03-01")) %>% group_by(county,state) %>% mutate(p_red_jail_pop = (first(jail_population)-last(jail_population))/first(jail_population)) %>%
  select(county,state,p_red_jail_pop) %>% distinct %>% arrange(desc(p_red_jail_pop))
jp_diff
```

Look at a particular county
```{r}
countyname = 'Clackamas'
statename = 'Oregon'
county_jp <- jp %>% filter(county==countyname,state==statename)
county_nyt<- nyt_data %>% filter(county==countyname,state==statename)
jp_nyt_county <- merge(county_jp,county_nyt,by=c('date','county','state')) %>% select(county,date,jail_population,cases)
jp_nyt_county$release_rate <- (lag(jp_nyt_county$jail_population,3)-jp_nyt_county$jail_population)/lag(jp_nyt_county$jail_population,3)*500
jp_nyt_county
melt(jp_nyt_county, id=c('date','county'))

ggplot(data=melt(jp_nyt_county, id=c('date','county'))) + geom_line(aes(date,value,color=variable))
```

Look at an entire state
```{r}
statename = 'Oregon'
state_jp <- jp %>% filter(state==statename) %>% group_by(date) %>% mutate(total_jailed = sum(jail_population)) %>% select(date,state,total_jailed) %>% unique()
state_nyt<- nyt_data %>% filter(state==statename) %>% group_by(date) %>% mutate(total_cases = sum(cases)) %>% select(date,state,total_cases) %>% unique()
jp_nyt_state <- merge(state_jp,state_nyt,by=c('date','state')) %>% select(date,total_jailed,total_cases)
jp_nyt_state
ggplot(data=melt(jp_nyt_state, id=c('date'))) + geom_line(aes(date,value,color=variable))
```

% difference in cases from March 1st to now
```{r}
nyt_diff <- nyt_data %>% filter(date >= as.Date("2020-03-01")) %>% group_by(county,state) %>% mutate(pdiff_cases = (last(cases)-first(cases))/first(cases)) %>% arrange(desc(pdiff_cases)) %>% select(county,state,pdiff_cases) %>% distinct
nyt_diff %>% filter(pdiff_cases < Inf)
```

Relationship between % difference in cases and % difference in jail population?
```{r}
diff_df <- merge(jp_diff,nyt_diff)
diff_df <- diff_df %>% drop_na()
diff_df$p_red_jail_pop <- diff_df$p_red_jail_pop
ggplot(data = diff_df) + geom_point(aes((log(p_red_jail_pop)),log(pdiff_cases)))
diff_df
```


Consider counties close in population to Clackamas
```{r}
state_by_state <- merge(nyt_jp_recent,diff_df) %>% select(county,state,jail_population,resident_population,jail_incarceration_rate_per_100k,cases,p_red_jail_pop,pdiff_cases)
small_state <- state_by_state %>% filter(abs(jail_incarceration_rate_per_100k-32.8)<50000) %>% arrange(desc(p_red_jail_pop))

ggplot(small_state) + geom_point(aes(p_red_jail_pop,pdiff_cases))
state_by_state
```

Mobile has a similar population, no jail reduction in population
```{r}
countyname = 'Mobile'
statename = 'Alabama'
county_jp <- jp %>% filter(county==countyname,state==statename)
county_nyt<- nyt_data %>% filter(county==countyname,state==statename)
jp_nyt_county <- merge(county_jp,county_nyt,by=c('date','county','state')) %>% select(county,date,jail_population,cases)

ggplot(data=melt(jp_nyt_county, id=c('date','county'))) + geom_line(aes(date,value,color=variable))
```

```{r}
countyname = 'Clackamas'
statename = 'Oregon'
county_jp <- jp %>% filter(county==countyname,state==statename)
county_nyt<- nyt_data %>% filter(county==countyname,state==statename)
jp_nyt_county <- merge(county_jp,county_nyt,by=c('date','county','state')) %>% select(county,date,jail_population,cases)

ggplot(data=melt(jp_nyt_county, id=c('date','county'))) + geom_line(aes(date,value,color=variable))
```

```{r}
prisons <- read_csv('prison_boundaries.csv')
prisons$COUNTY <- tolower(prisons$COUNTY)
prisons <- prisons %>% rename(county = COUNTY,Code=STATE)
#prisons %>% select(NAME,Code,county)

statenames <- read_csv('state_abbreviations.csv') %>% select(State,Code)
prison_df <- merge(statenames,prisons) %>% select(State,NAME,county)
prison_df
```

Prison data: for each state, fraction of prisoners released
```{r}
pr <- read_csv('covid_prison_releases.csv') 
pr <- pr %>% rename(prior_pop = 'Population Prior to Releases',releases = "Overall Pop. Reduction / \nTotal Number of Releases") %>% select(State,Facility,prior_pop,releases) %>% drop_na() %>% filter(Facility=='Statewide')
pr$releases <- as.numeric(pr$releases)
pr$frac_released <- pr$releases/pr$prior_pop
pr <- pr %>% drop_na()
pr %>% arrange(frac_released)
```

For each prison county, the cases over time, and the fraction of prisoners released in that state
```{r}
# state, frac_released, county containing a prison
PRDF <- merge(pr,prison_df) %>% select(State,frac_released,county) %>% rename(state=State)
nyt_data$county <- tolower(nyt_data$county)
PRDF <- merge(nyt_data,PRDF)
PRDF %>% select(county,state,frac_released,date,cases,deaths)
```



```{r}
# jail population dataframe with fraction released

jp_frac_rel <- jp %>% group_by(county,state) %>% filter(first(jail_population) >20)%>% 
  mutate(num_released = first(jail_population)-last(jail_population)) %>% 
  mutate(frac_released = num_released/first(jail_population)) %>%
  select(county,state,frac_released,num_released,resident_population) %>%
  unique() %>% arrange(desc(frac_released))

# 5 quantiles
(quantile(jp_frac_rel$frac_released, c(.2,.4,.6,.8,1)))


jp_frac_rel$quantile <- ifelse(jp_frac_rel$frac_released<.08,5,
                               ifelse(jp_frac_rel$frac_released<.19,4,
                                      ifelse(jp_frac_rel$frac_released<.29,3,
                                             ifelse(jp_frac_rel$frac_released<.40,2,1))))

jp_frac_rel

release_df <- merge(nyt_recent,jp_frac_rel) %>%
  select(state,county,cases,deaths,frac_released,quantile,resident_population) %>%
  mutate(infection_rate=cases/resident_population)
release_df$quantile <- as.factor(release_df$quantile)

ggplot(release_df) + geom_violin(aes(quantile,log(infection_rate)))
```


```{r}
release_df
filtered_df <- release_df %>% filter(state %in% c('California','Oregon','Ohio','Michigan','New York'))
ggplot(filtered_df) + geom_point(aes((frac_released),log(infection_rate),color=state,size=resident_population))
```

